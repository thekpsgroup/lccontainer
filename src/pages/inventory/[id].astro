---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import Lightbox from "../../components/Lightbox.astro";
import DeliveryEstimator from "../../components/DeliveryEstimator.astro";
import { INVENTORY, type Item } from "../../data/inventory";
import BreadcrumbSchema from "../../components/BreadcrumbSchema.astro";

export async function getStaticPaths() {
  return INVENTORY.map((item) => ({
    params: { id: item.id },
    props: { item },
  }));
}

const { item } = Astro.props;

const title = `${item.title} — LC Container`;
const desc = `${item.title}: ${item.blurb} · ${item.condition}. From $${item.priceFrom.toLocaleString()}. Quotes in 24 hours.`;
---
<BaseLayout title={title} description={desc}>
  <Header />

  <section class="max-w-[1200px] mx-auto px-5 py-12 md:py-16">
    <BreadcrumbSchema items={[
      { name: "Home", url: "/" },
      { name: "Inventory", url: "/inventory" },
      { name: item.title, url: `/inventory/${item.id}` }
    ]} />

    <div class="grid lg:grid-cols-2 gap-8 items-start">
      <!-- Gallery -->
      <div class="border border-grey-300 bg-white p-0 overflow-hidden">
        <div id="carousel" class="relative aspect-[4/3] bg-grey-100">
          <button
            id="cimg-btn"
            class="absolute inset-0 w-full h-full cursor-pointer image-overlay lightbox-trigger"
            aria-label={`Enlarge ${item.title} image`}
            data-lightbox-src={item.photos[0]}
            data-lightbox-alt={item.title}
            data-lightbox-title={item.title}
            data-lightbox-caption={item.blurb}
          >
            <img id="cimg" src={item.photos[0]} alt={`${item.title} - ${item.size} ${item.height} ${item.condition} shipping container for sale at LC Container Texas`} class="h-full w-full object-cover" loading="eager" onerror="this.style.display='none'" />
          </button>
          <button id="prev" class="absolute left-3 top-1/2 -translate-y-1/2 px-3 py-2 bg-white border border-grey-300 z-10 hover:bg-grey-100">‹</button>
          <button id="next" class="absolute right-3 top-1/2 -translate-y-1/2 px-3 py-2 bg-white border border-grey-300 z-10 hover:bg-grey-100">›</button>
        </div>
        <div class="grid grid-cols-4 gap-2 p-3">
          {item.photos.map((p,idx) => (
            <button class="group relative h-16 overflow-hidden border border-grey-300">
              <img src={p} alt={`${item.title} - ${item.size} container photo ${idx+1} at LC Container yard`} class="h-full w-full object-cover group-hover:opacity-80" loading="lazy" onerror="this.style.display='none'"/>
            </button>
          ))}
        </div>
      </div>

      <!-- Details -->
      <div class="border border-grey-300 bg-white p-6">
        <h1 class="text-2xl md:text-3xl font-semibold text-black">{item.title}</h1>
        <div class="mt-2 flex flex-wrap items-center gap-2 text-xs">
          <span class="px-2 py-1 bg-grey-100 border border-grey-300 text-black">{item.size}</span>
          <span class="px-2 py-1 bg-grey-100 border border-grey-300 text-black">{item.height}</span>
          <span class="px-2 py-1 bg-grey-100 border border-grey-300 text-black">{item.condition}</span>
          {item.badge && <span class="px-2 py-1 bg-grey-100 border border-grey-300 text-black">{item.badge}</span>}
          {item.inStock ? <span class="px-2 py-1 bg-grey-100 border border-grey-300 text-black">In Stock</span> : <span class="px-2 py-1 bg-grey-100 border border-grey-300 text-black">Check ETA</span>}
        </div>

        <p class="text-grey-600 mt-3">{item.blurb}</p>
        <p class="text-sm text-grey-600 mt-2 font-semibold">Call for Pricing</p>

        <div class="mt-4 flex gap-2">
          <a href={`/contact?interest=${encodeURIComponent(item.title)}`} data-astro-prefetch class="px-4 py-2 bg-brand-red text-white text-sm font-semibold hover:bg-brand-red-dark">Get Quote</a>
          <a href="/inventory" data-astro-prefetch class="px-4 py-2 border border-grey-300 bg-white text-black text-sm hover:bg-grey-100">Back to Inventory</a>
        </div>

        <h2 class="text-lg font-semibold mt-6 text-black">Specs</h2>
        <ul class="text-sm text-grey-600 list-disc pl-5 mt-2">
          {item.specs.map(s => <li>{s}</li>)}
        </ul>
        <p class="text-xs text-grey-600 mt-3">
          Planning a build? <a href="/custom-builds" data-astro-prefetch class="hover:underline text-brand-red">See custom examples</a>
        </p>

        <div class="mt-6">
          <DeliveryEstimator itemTitle={item.title} />
        </div>

        <!-- Trust -->
        <div class="mt-6 grid sm:grid-cols-2 gap-3 text-sm">
          <div class="border border-grey-300 bg-grey-100 p-3 text-center"><div class="font-semibold text-black">Licensed & Insured</div></div>
          <div class="border border-grey-300 bg-grey-100 p-3 text-center"><div class="font-semibold text-black">Quotes in 24h</div></div>
          <div class="border border-grey-300 bg-grey-100 p-3 text-center"><div class="font-semibold text-black">10-Acre Yard</div></div>
          <div class="border border-grey-300 bg-grey-100 p-3 text-center"><div class="font-semibold text-black">200-Mile Service</div></div>
        </div>
      </div>
    </div>
  </section>

  <Lightbox id="lb" alt="Expanded inventory photo" />

  <!-- Product schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Product",
    "name": {item.title},
    "description": {item.blurb},
    "brand": { "name": "LC Container" },
    "sku": {item.id},
    "offers": {
      "@type": "Offer",
      "priceCurrency": "USD",
      "price": {item.priceFrom},
      "availability": "{item.inStock ? 'https://schema.org/InStock' : 'https://schema.org/PreOrder'}",
      "url": {"https://lccontainer.com/inventory/" + item.id}
    }
  }
  </script>

  <script define:vars={{ photos: item.photos ?? [] }}>
    // Gallery: previous/next + thumbs
    let idx = 0;
    const cimg = document.getElementById('cimg');
    const prev = document.getElementById('prev');
    const next = document.getElementById('next');
    const thumbs = Array.from(document.querySelectorAll('.grid .group img'));
    function show(i){
      idx = (i+photos.length)%photos.length;
      if(cimg) cimg.src = photos[idx] || "";
      // Update lightbox button data attributes
      const cimgBtn = document.getElementById('cimg-btn');
      if(cimgBtn) {
        cimgBtn.setAttribute('data-lightbox-src', photos[idx] || "");
        const h1 = document.querySelector('h1');
        const caption = document.querySelector('.text-ink-muted');
        if (h1) {
          cimgBtn.setAttribute('data-lightbox-alt', h1.textContent || "");
          cimgBtn.setAttribute('data-lightbox-title', h1.textContent || "");
        }
        if (caption) {
          cimgBtn.setAttribute('data-lightbox-caption', caption.textContent || "");
        }
      }
    }
    prev?.addEventListener('click', ()=> show(idx-1));
    next?.addEventListener('click', ()=> show(idx+1));
    thumbs.forEach((t,i)=> t.parentElement?.addEventListener('click', ()=> show(i)));
  </script>
</BaseLayout>
