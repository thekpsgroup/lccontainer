---
const interests = ["Buy - 20'","Buy - 40'","Buy - 40' High Cube","Lease","Custom Build","Not sure"];
---

<div class="border border-grey-300 bg-white p-6 md:p-8" role="form" aria-labelledby="quote-title">
  <h2 id="quote-title" class="text-2xl font-bold mb-2 text-black">Get a Free Quote</h2>
  <p class="text-sm text-grey-600">We'll reply within 24 hours. No hidden fees.</p>

  <form id="quoteForm" class="grid gap-4 mt-4" action="https://formsubmit.co/info@lccontainer.com" method="POST" novalidate>
    <!-- Enhanced spam protection: Multiple honeypots -->
    <input type="text" name="website" tabindex="-1" autocomplete="off" class="hidden" aria-hidden="true" />
    <input type="text" name="company" tabindex="-1" autocomplete="off" class="hidden" aria-hidden="true" />
    <input type="text" name="url" tabindex="-1" autocomplete="off" class="hidden" aria-hidden="true" />
    <input type="hidden" name="startedAt" id="startedAt" />
    <input type="hidden" name="formToken" id="formToken" />

    <!-- FormSubmit configuration with CAPTCHA enabled -->
    <input type="hidden" name="_subject" value="New Quote Request from LC Container Website" />
    <input type="hidden" name="_captcha" value="true" />
    <input type="hidden" name="_template" value="table" />
    <input type="hidden" name="_next" value="https://lccontainer.com/contact?submitted=true" />
    <input type="hidden" name="_autoresponse" value="Thank you for your quote request! We'll call you within 24 hours. If you don't hear from us, please call (214) 524-4168." />

    <!-- stepper -->
    <ol class="flex items-center gap-2 text-xs" role="progressbar" aria-label="Quote form progress" aria-valuenow="1" aria-valuemin="1" aria-valuemax="4">
      <li id="label-1" class="px-3 py-1 bg-brand-red text-white" aria-current="step">1. Contact</li>
      <li id="label-2" class="px-3 py-1 border border-grey-300 bg-grey-100 text-grey-600">2. Need</li>
      <li id="label-3" class="px-3 py-1 border border-grey-300 bg-grey-100 text-grey-600">3. Delivery</li>
      <li id="label-4" class="px-3 py-1 border border-grey-300 bg-grey-100 text-grey-600">4. Confirm</li>
    </ol>

    <!-- Step 1 -->
    <fieldset class="step" data-step="1">
      <label class="block text-sm text-black" for="name">Full Name
        <input id="name" name="name" required autocomplete="name" aria-describedby="name-help" class="mt-1 w-full px-4 py-3 border border-grey-300 bg-white focus:outline-none focus:ring-2 focus:ring-brand-red text-base" />
      </label>
      <div id="name-help" class="sr-only">Enter your full name for the quote request</div>

      <label class="block text-sm text-black" for="email">Email
        <input id="email" name="email" type="email" required autocomplete="email" aria-describedby="email-help email-error" class="mt-1 w-full px-4 py-3 border border-grey-300 bg-white focus:outline-none focus:ring-2 focus:ring-brand-red text-base" />
        <span id="email-error" class="text-xs text-red-600 hidden mt-1" role="alert"></span>
      </label>
      <div id="email-help" class="sr-only">We'll use this email to send your quote and updates</div>

      <label class="block text-sm text-black" for="phone">Phone
        <input id="phone" name="phone" required autocomplete="tel" inputmode="tel" aria-describedby="phone-help phone-error" class="mt-1 w-full px-4 py-3 border border-grey-300 bg-white focus:outline-none focus:ring-2 focus:ring-brand-red text-base" />
        <span id="phone-error" class="text-xs text-red-600 hidden mt-1" role="alert"></span>
      </label>
      <div id="phone-help" class="sr-only">We'll call you within 24 hours to discuss your container needs</div>
    </fieldset>

    <!-- Step 2 -->
    <fieldset class="step hidden" data-step="2">
        <label class="block text-sm text-black" for="interest">What do you need?
          <select id="interest" name="interest" required aria-describedby="interest-help" class="mt-1 w-full px-4 py-3 border border-grey-300 bg-white focus:outline-none focus:ring-2 focus:ring-brand-red text-base">
            <option value="">Select an option</option>
            {interests.map(i => <option value={i}>{i}</option>)}
          </select>
        </label>
        <div id="interest-help" class="sr-only">Choose the type of container service you're interested in</div>
      </fieldset>

    <!-- Step 3 -->
    <fieldset class="step hidden" data-step="3">
      <label class="block text-sm text-black" for="zip">Delivery ZIP
        <input id="zip" name="zip" placeholder="e.g., 75141" required inputmode="numeric" pattern="\\d{5}" aria-describedby="zip-help" maxlength="5" class="mt-1 w-full px-4 py-3 border border-grey-300 bg-white focus:outline-none focus:ring-2 focus:ring-brand-red text-base" />
      </label>
      <div id="zip-help" class="sr-only">Enter your 5-digit ZIP code for delivery estimate</div>

      <label class="block text-sm text-black" for="notes">Notes (optional)
        <textarea id="notes" name="notes" rows="3" placeholder="Site conditions, timeframe, add-ons needed…" aria-describedby="notes-help" class="mt-1 w-full px-4 py-3 border border-grey-300 bg-white focus:outline-none focus:ring-2 focus:ring-brand-red text-base"></textarea>
      </label>
      <div id="notes-help" class="sr-only">Any additional details about your container requirements</div>
    </fieldset>

    <!-- Step 4 -->
    <section class="step hidden" data-step="4">
      <div class="text-sm text-grey-600">We'll review your info and send a quote within 24 hours.</div>
    </section>

    <!-- Controls -->
    <div class="flex gap-3 mt-1">
      <button type="button" id="prevBtn" class="hidden px-5 py-3 border border-grey-300 bg-white text-black hover:bg-grey-100 focus:ring-2 focus:ring-brand-red" aria-label="Go back to previous step">
        Back
      </button>
      <button type="button" id="nextBtn" class="px-5 py-3 bg-brand-red text-white font-semibold hover:bg-brand-red-dark focus:ring-2 focus:ring-brand-red" aria-label="Continue to next step">
        Next
      </button>
      <button type="submit" id="submitBtn" class="hidden px-5 py-3 bg-brand-red text-white font-semibold hover:bg-brand-red-dark focus:ring-2 focus:ring-brand-red" aria-label="Submit your quote request" disabled>
        <span id="submitText">Submit Quote Request</span>
        <span id="submitLoading" class="hidden" aria-live="polite">Sending your request...</span>
      </button>
    </div>

    <p id="formMsg" class="text-sm text-grey-600 mt-1 flex items-center gap-2" role="status" aria-live="polite">
      <span id="errorIcon" class="hidden text-brand-red" aria-hidden="true">⚠</span>
      <span id="errorText"></span>
    </p>
  </form>
</div>

<script>
  // Performance optimization: Debounce function
  function debounce(func: (...args: any[]) => any, wait: number) {
    let timeout: ReturnType<typeof setTimeout> | undefined;
    return function executedFunction(...args: any[]) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // init
  const steps = /** @type {NodeListOf<HTMLElement>} */(document.querySelectorAll('.step'));
  const labels = [1,2,3,4].map(i => document.getElementById('label-'+i));
  const nextBtn = document.getElementById('nextBtn') as HTMLButtonElement;
  const prevBtn = document.getElementById('prevBtn') as HTMLButtonElement;
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
  const submitText = document.getElementById('submitText') as HTMLElement;
  const submitLoading = document.getElementById('submitLoading') as HTMLElement;
  const form = /** @type {HTMLFormElement} */(document.getElementById('quoteForm'));
  const msg = document.getElementById('formMsg') as HTMLElement;
  const errorIcon = document.getElementById('errorIcon') as HTMLElement;
  const errorText = document.getElementById('errorText') as HTMLElement;
  const startedAt = document.getElementById('startedAt') as HTMLInputElement;

  // Initialize form with spam protection
  const formToken = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
  if (startedAt) {
    startedAt.value = String(Date.now());
  }
  const tokenInput = document.getElementById('formToken') as HTMLInputElement;
  if (tokenInput) {
    tokenInput.value = formToken;
  }
  
  // Rate limiting: Check if form was submitted recently
  const lastSubmissionKey = 'lc_container_last_form_submission';
  const minTimeBetweenSubmissions = 60000; // 1 minute
  
  function checkRateLimit(): boolean {
    const lastSubmission = localStorage.getItem(lastSubmissionKey);
    if (lastSubmission) {
      const timeSinceLastSubmission = Date.now() - parseInt(lastSubmission);
      if (timeSinceLastSubmission < minTimeBetweenSubmissions) {
        return false; // Too soon
      }
    }
    return true; // OK to submit
  }
  
  function setRateLimit() {
    localStorage.setItem(lastSubmissionKey, String(Date.now()));
  }
  
  let current = 0;
  let isSubmitting = false;

  function showStep(i: number) {
    steps.forEach((s,idx)=> s.classList.toggle('hidden', idx!==i));
    labels.forEach((l,idx)=> l?.classList.toggle('opacity-60', idx>i));
    prevBtn.classList.toggle('hidden', i===0);
    nextBtn.classList.toggle('hidden', i===steps.length-1);
    submitBtn.classList.toggle('hidden', i!==steps.length-1);

    // Focus management for accessibility
    const focusableElement = steps[i].querySelector('input,select,textarea') as HTMLElement;
    if (focusableElement) {
      setTimeout(() => focusableElement.focus(), 100);
    }
  }
  showStep(current);

  function setLoading(loading: boolean) {
    isSubmitting = loading;
    if (loading) {
      if (submitText) submitText.classList.add('hidden');
      if (submitLoading) submitLoading.classList.remove('hidden');
      if (submitBtn) submitBtn.disabled = true;
      if (nextBtn) nextBtn.disabled = true;
      if (prevBtn) prevBtn.disabled = true;
    } else {
      if (submitText) submitText.classList.remove('hidden');
      if (submitLoading) submitLoading.classList.add('hidden');
      if (submitBtn) submitBtn.disabled = false;
      if (nextBtn) nextBtn.disabled = false;
      if (prevBtn) prevBtn.disabled = false;
    }
  }

    function validateStep(i: number){
      // Check if form exists
      if (!form) return "Form not found";

      // Enhanced validation with better error messages
      if(i===0){
      const name = form.elements.namedItem('name');
      const email = form.elements.namedItem('email');
      const phone = form.elements.namedItem('phone');

      if(!name.value || !email.value || !phone.value) return "Please fill in all required fields.";
      if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email.value)) return "Please enter a valid email address.";
      if(!/^[\+]?[1-9][\d]{0,15}$/.test(phone.value.replace(/\D/g,''))) return "Please enter a valid phone number.";
      }
      if(i===1){
        const interest = form.elements.namedItem('interest');
        if(!interest.value) return "Please select what you need.";
      }
      if(i===2){
        const zip = form.elements.namedItem('zip');
        if(!/^\d{5}$/.test(zip.value)) return "Please enter a valid 5-digit ZIP code.";
      }
      return null;
  }

  // Debounced error clearing
  const clearError = debounce(() => {
    if (errorText.textContent && !errorText.textContent.includes('Thanks!')) {
      errorText.textContent = '';
      errorIcon.classList.add('hidden');
      msg.classList.remove('text-red-500');
      msg.classList.add('text-ink-muted');
    }
  }, 3000);

  nextBtn.addEventListener('click', ()=>{
    if (isSubmitting) return;

    const err = validateStep(current);
    if(err){
      errorText.textContent = err;
      errorIcon.classList.remove('hidden');
      msg.classList.remove('text-ink-muted');
      msg.classList.add('text-red-500');
      clearError();
      return;
    }
    if(current < steps.length-1){
      current++;
      showStep(current);
      errorText.textContent="";
      errorIcon.classList.add('hidden');
      msg.classList.remove('text-red-500');
      msg.classList.add('text-ink-muted');
    }
  });

  prevBtn.addEventListener('click', ()=>{
    if (isSubmitting) return;

    if(current>0){
      current--;
      showStep(current);
      errorText.textContent="";
      errorIcon.classList.add('hidden');
      msg.classList.remove('text-red-500');
      msg.classList.add('text-ink-muted');
    }
  });

  form.addEventListener('submit', async (e)=>{
    e.preventDefault(); // Prevent default to add spam checks
    
    if (isSubmitting) {
      return;
    }

    // Spam protection checks
    const fd = new FormData(form);
    const payload = Object.fromEntries(fd.entries());
    
    // Check honeypot fields (should be empty)
    if (payload.website || payload.company || payload.url) {
      errorText.textContent = "Spam detected. Please contact us directly at (214) 524-4168.";
      errorIcon.classList.remove('hidden');
      msg.classList.remove('text-ink-muted');
      msg.classList.add('text-red-500');
      return;
    }
    
    // Check form timing (too fast = likely spam)
    const startTime = parseInt(startedAt?.value || '0');
    const timeSpent = Date.now() - startTime;
    const minTimeToFill = 5000; // 5 seconds minimum
    
    if (timeSpent < minTimeToFill) {
      errorText.textContent = "Please take your time filling out the form.";
      errorIcon.classList.remove('hidden');
      msg.classList.remove('text-ink-muted');
      msg.classList.add('text-red-500');
      return;
    }
    
    // Check rate limiting
    if (!checkRateLimit()) {
      errorText.textContent = "Please wait a moment before submitting again. Or call us at (214) 524-4168.";
      errorIcon.classList.remove('hidden');
      msg.classList.remove('text-ink-muted');
      msg.classList.add('text-red-500');
      return;
    }
    
    // Validate email domain (block common spam domains)
    const email = payload.email as string;
    const spamDomains = ['tempmail.com', '10minutemail.com', 'guerrillamail.com', 'mailinator.com', 'throwaway.email'];
    const emailDomain = email.split('@')[1]?.toLowerCase();
    if (emailDomain && spamDomains.some(domain => emailDomain.includes(domain))) {
      errorText.textContent = "Please use a valid email address or call us at (214) 524-4168.";
      errorIcon.classList.remove('hidden');
      msg.classList.remove('text-ink-muted');
      msg.classList.add('text-red-500');
      return;
    }
    
    // Validate phone number format
    const phone = (payload.phone as string).replace(/\D/g, '');
    if (phone.length < 10 || phone.length > 15) {
      errorText.textContent = "Please enter a valid phone number.";
      errorIcon.classList.remove('hidden');
      msg.classList.remove('text-ink-muted');
      msg.classList.add('text-red-500');
      return;
    }

    setLoading(true);
    errorText.textContent = "Sending…";
    errorIcon.classList.add('hidden');
    msg.classList.remove('text-red-500');
    msg.classList.add('text-ink-muted');
    
    // Set rate limit
    setRateLimit();

    // Enhanced analytics tracking
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
      event: "quote_submit",
      interest: payload.interest,
      zip: payload.zip,
      timestamp: Date.now()
    });

    // Submit the form
    try {
      const response = await fetch(form.action, {
        method: 'POST',
        body: fd
      });
      
      if (response.ok) {
        // Success - redirect
        window.location.href = 'https://lccontainer.com/contact?submitted=true';
      } else {
        throw new Error('Submission failed');
      }
    } catch (error) {
      setLoading(false);
      errorText.textContent = "There was an error submitting your form. Please call us at (214) 524-4168.";
      errorIcon.classList.remove('hidden');
      msg.classList.remove('text-ink-muted');
      msg.classList.add('text-red-500');
    }
  });

  // Show success message function
  function showSuccessMessage() {
    const successEvent = new CustomEvent('showSuccessMessage', {
      detail: {
        title: 'Quote Request Submitted!',
        message: 'Thanks! We\'ll call you within 24h. If you don\'t hear from us, please call (214) 524-4168.'
      }
    });
    document.dispatchEvent(successEvent);
  }

  // Real-time validation
  const emailInput = form?.elements?.namedItem('email') as HTMLInputElement;
  const phoneInput = form?.elements?.namedItem('phone') as HTMLInputElement;
  const emailError = document.getElementById('email-error');
  const phoneError = document.getElementById('phone-error');
  
  // Email validation
  emailInput?.addEventListener('blur', () => {
    const email = emailInput.value;
    if (email && !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
      if (emailError) {
        emailError.textContent = 'Please enter a valid email address';
        emailError.classList.remove('hidden');
        emailInput.classList.add('border-red-500');
      }
    } else {
      if (emailError) {
        emailError.classList.add('hidden');
        emailInput.classList.remove('border-red-500');
      }
    }
  });
  
  // Phone validation and formatting
  phoneInput?.addEventListener('input', (e) => {
    const input = e.target as HTMLInputElement;
    let value = input.value.replace(/\D/g, '');
    
    // Format as (XXX) XXX-XXXX
    if (value.length > 0) {
      if (value.length <= 3) {
        value = `(${value}`;
      } else if (value.length <= 6) {
        value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
      } else {
        value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
      }
      input.value = value;
    }
    
    // Validate
    const digits = value.replace(/\D/g, '');
    if (digits.length > 0 && (digits.length < 10 || digits.length > 15)) {
      if (phoneError) {
        phoneError.textContent = 'Please enter a valid phone number';
        phoneError.classList.remove('hidden');
        phoneInput.classList.add('border-red-500');
      }
    } else {
      if (phoneError) {
        phoneError.classList.add('hidden');
        phoneInput.classList.remove('border-red-500');
      }
    }
  });
  
  phoneInput?.addEventListener('blur', () => {
    const digits = phoneInput.value.replace(/\D/g, '');
    if (digits.length > 0 && (digits.length < 10 || digits.length > 15)) {
      if (phoneError) {
        phoneError.textContent = 'Please enter a valid phone number';
        phoneError.classList.remove('hidden');
        phoneInput.classList.add('border-red-500');
      }
    }
  });

  // Prefill from URL with error handling
  try {
    const params = new URLSearchParams(location.search);
    const interestEl = form?.elements?.namedItem?.('interest');
    const zipEl = form?.elements?.namedItem?.('zip');

    if (interestEl && params.get('interest')) {
      [...interestEl.options].forEach(o => {
        if (o.value === params.get('interest')) o.selected = true;
      });
    }
    if (zipEl && params.get('zip')) {
      zipEl.value = params.get('zip');
    }
  } catch (error) {
    if (import.meta.env.DEV) {
      console.error('URL parameter parsing error:', error);
    }
  }
</script>
